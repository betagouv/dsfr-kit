/**
 * {{ component_name | title }} Web Component
 * Generated from DSFR {{ dsfr_version }}
 *
 * Usage: <{{ custom_element_name }}>{{ slot_content }}</{{ custom_element_name }}>
 */

class {{ class_name }} extends HTMLElement {
  constructor() {
    super();
    // Light DOM - no shadow root
    this._originalContent = this.innerHTML; // Capture initial content

    // Initialize state variables
    {% for state_var in state_variables %}
    this.{{ state_var.name }} = {{ state_var.initial_value }};
    {% endfor %}
  }

  static get observedAttributes() {
    return [{% if variants %}'variant', {% endif %}{% for attr in aria_attributes %}'{{ attr }}'{% if not loop.last %}, {% endif %}{% endfor %}];
  }

  connectedCallback() {
    if (!this._originalContent && this.innerHTML.trim()) {
       this._originalContent = this.innerHTML;
    }
    this.render();
    {% if has_behaviors %}
    this.setupEventListeners();
    {% endif %}
  }

  disconnectedCallback() {
    {% if has_behaviors %}
    this.removeEventListeners();
    {% endif %}
  }

  attributeChangedCallback(name, oldValue, newValue) {
    if (oldValue !== newValue) {
      this.render();
      {% if has_behaviors %}
      this.handleAttributeChange(name, oldValue, newValue);
      {% endif %}
    }
  }

  {% if has_behaviors %}
  setupEventListeners() {
    // Note: In Light DOM, we attach listeners to the internal element or this?
    // The previous logic used 'this.addEventListener'.
    // If events bubble, 'this' captures them.

    {% for listener in event_listeners %}
    this.addEventListener('{{ listener.event }}', this.{{ listener.handler_name }}.bind(this));
    {% endfor %}
  }

  removeEventListeners() {
    {% for listener in event_listeners %}
    this.removeEventListener('{{ listener.event }}', this.{{ listener.handler_name }}.bind(this));
    {% endfor %}
  }

  handleAttributeChange(name, oldValue, newValue) {
    // Handle attribute changes based on DSFR behavior patterns
    {% for transition in state_transitions %}
    {% if transition.trigger_type == 'attribute' %}
    if (name === '{{ transition.trigger_attribute }}') {
      this.{{ transition.action }}();
    }
    {% endif %}
    {% endfor %}
  }

  {% for listener in event_listeners %}
  {{ listener.handler_name }}(event) {
    {% for action in listener.actions %}
    // {{ action.description }}
    {% if action.type == 'state_change' %}
    this.{{ action.target }} = {{ action.value }};
    {% elif action.type == 'dom_manipulation' %}
    this.{{ action.method }}({{ action.params | join(', ') }});
    {% elif action.type == 'aria_change' %}
    this.setAttribute('{{ action.attribute }}', '{{ action.value }}');
    {% elif action.type == 'custom' %}
    {{ action.code }}
    {% endif %}
    {% endfor %}
  }

  {% endfor %}
  {% endif %}

  render() {
    const variant = this.getAttribute('variant') || '{{ default_variant }}';
    {% if aria_attributes %}
    const ariaLabel = this.getAttribute('aria-label') || '{{ aria_attributes.get("aria-label", "") }}';
    const role = this.getAttribute('role') || '{{ aria_attributes.get("role", "") }}';
    {% endif %}

    // Extra CSS (icons) - Inject style only once if needed
    const styleId = 'dsfr-{{ custom_element_name }}-style';
    if (!document.getElementById(styleId)) {
        const style = document.createElement('style');
        style.id = styleId;
        style.textContent = `
        /* DSFR color tokens */
        {% for color in colors %}
        .{{ color.tailwind_class }} {
          color: {{ color.value }};
        }
        {% endfor %}

        {{ extra_css }}
        `;
        document.head.appendChild(style);
    }

    this.innerHTML = `
      <{{ tag }}
        {% if attributes %}
        {% for attr_name, attr_value in attributes.items() %}
        {{ attr_name }}="{{ attr_value }}"
        {% endfor %}
        {% endif %}
        {% if aria_attributes %}
        {% for aria_name, aria_value in aria_attributes.items() %}
        {{ aria_name }}="{{ aria_value }}"
        {% endfor %}
        {% endif %}
        class="{{ tailwind_classes | join(' ') }}"
      >
        ${this._originalContent || '{{ default_text }}'}
      </{{ tag }}>
    `;
  }
}

customElements.define('{{ custom_element_name }}', {{ class_name }});

$schema: 'https://moonrepo.dev/schemas/tasks.json'

fileGroups:
  configs:
    - 'package.json'
    - 'tsconfig.json'
    - 'pyproject.toml'
    - 'uv.lock'
    - 'pnpm-lock.yaml'
  sources:
    - 'src/**/*'
    - 'lib/**/*'
    - 'tests/**/*'

tasks:
  build:
    deps:
      - '^:build'
    outputs:
      - 'dist'
    inputs:
      - '@group(sources)'
      - '@group(configs)'

  test:
    deps:
      - 'build'
    inputs:
      - '@group(sources)'
      - '@group(configs)'
    options:
      runInCI: true

  test-coverage:
    deps:
      - 'build'
    inputs:
      - '@group(sources)'
      - '@group(configs)'
    options:
      runInCI: true

  lint-biome:
    command: "sh -c 'if [ -f package.json ]; then $MOON_WORKSPACE_ROOT/node_modules/.bin/biome check --write . || exit 1; fi'"
    platform: system
    inputs:
      - '@group(sources)'
      - '/biome.json'
    options:
      runInCI: true

  lint-ruff:
    command: "sh -c 'if [ -f pyproject.toml ]; then uv run --project $MOON_WORKSPACE_ROOT ruff check . || exit 1; fi'"
    platform: system
    inputs:
      - '@group(sources)'
      - '/pyproject.toml'
    options:
      runInCI: true

  lint:
    deps:
      - 'lint-biome'
      - 'lint-ruff'
    options:
      runInCI: true

  fix-biome:
    command: "sh -c 'if [ -f package.json ]; then $MOON_WORKSPACE_ROOT/node_modules/.bin/biome check --write --unsafe . || exit 1; fi'"
    platform: system
    inputs:
      - '@group(sources)'
      - '/biome.json'
    options:
      cache: false

  fix-ruff:
    command: "sh -c 'if [ -f pyproject.toml ]; then uv run --project $MOON_WORKSPACE_ROOT ruff check --fix . || exit 1; fi'"
    platform: system
    inputs:
      - '@group(sources)'
      - '/pyproject.toml'
    options:
      cache: false

  fix:
    deps:
      - 'fix-biome'
      - 'fix-ruff'
      - 'format'

  format-biome:
    command: "sh -c 'if [ -f package.json ]; then $MOON_WORKSPACE_ROOT/node_modules/.bin/biome format --write . || exit 1; fi'"
    platform: system
    inputs:
      - '@group(sources)'
      - '/biome.json'
    options:
      runInCI: true

  format-ruff:
    command: "sh -c 'if [ -f pyproject.toml ]; then uv run --project $MOON_WORKSPACE_ROOT ruff format . || exit 1; fi'"
    platform: system
    inputs:
      - '@group(sources)'
      - '/pyproject.toml'
    options:
      runInCI: true

  format:
    deps:
      - 'format-biome'
      - 'format-ruff'
    options:
      runInCI: true

  clean:
    command: 'rm -rf dist build'
    options:
        mergeArgs: 'replace'
